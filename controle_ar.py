from tinytuya import Contrib
import json

ir = None
HEAD_FIXO = ""
comandos_temp = {}
comando_desligar = ""
modos = []
fans = []
status = {}

def inicializar_ar(devices):
    global ir, HEAD_FIXO, comandos_temp, comando_desligar, modos, fans, status

    ar_device = next((d for d in devices if d.get("tipo") == "ar"), None)
    if not ar_device:
        raise Exception("Dispositivo de ar-condicionado não encontrado em meus_dispositivos.json")

    DEVICE_ID = ar_device["id"]
    DEVICE_IP = ar_device.get("ip", "")
    LOCAL_KEY = ar_device["key"]
    HEAD_FIXO = ar_device.get("head", "")

    ir = Contrib.IRRemoteControlDevice(DEVICE_ID, DEVICE_IP, LOCAL_KEY, persist=True)
    status = carregar_status(devices)

    
    # Dicionários de comandos do ar condicionado Gree, usar o ir_scan.py ou buscar os dados no log do dispositivo na nuvem tuya
    valor_humidade = {  16: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        17: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        18: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        19: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        20: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        21: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        22: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        23: "01$%002358E0040A40@^002008040007@&$%002358E0040E40@^002000000803@*",
                        24: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        25: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        26: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        27: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        28: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        29: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*",
                        30: "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*"}
    
    vau = "01$%00231890040A40@^002008040007@&$%00231890040E40@^002000000803@*"
    valor_automatico = {16: vau, 17: vau, 18: vau, 19: vau, 20: vau, 21: vau, 22: vau, 23: vau, 24: vau, 25: vau, 26: vau, 27: vau, 28: vau, 29: vau, 30: vau}

    comandos_temp.update({
        "esfriar": {
            "baixo": {
                16: "01$%00239800040A40@^002008040006@&$%00239800040E40@^002000000802@*",
                17: "01$%00239880040A40@^00200804000E@&$%00239880040E40@^00200000080A@*",
                18: "01$%00239840040A40@^002008040001@&$%00239840040E40@^002000000806@*",
                19: "01$%002398C0040A40@^002008040009@&$%002398C0040E40@^00200000080E@*",
                20: "01$%00239820040A40@^002008040005@&$%00239820040E40@^002000000801@*",
                21: "01$%002398A0040A40@^00200804000D@&$%002398A0040E40@^002000000809@*",
                22: "01$%00239860040A40@^002008040003@&$%00239860040E40@^002000000805@*",
                23: "01$%002398E0040A40@^00200804000B@&$%002398E0040E40@^00200000080D@*",
                24: "01$%00239810040A40@^002008040007@&$%00239810040E40@^002000000803@*",
                25: "01$%00239890040A40@^00200804000F@&$%00239890040E40@^00200000080B@*",
                26: "01$%00239850040A40@^002008040000@&$%00239850040E40@^002000000807@*",
                27: "01$%002398D0040A40@^002008040008@&$%002398D0040E40@^00200000080F@*",
                28: "01$%00239830040A40@^002008040004@&$%00239830040E40@^002000000800@*",
                29: "01$%002398B0040A40@^00200804000C@&$%002398B0040E40@^002000000808@*",
                30: "01$%00239870040A40@^002008040002@&$%00239870040E40@^002000000804@*"
            },
            "medio": {
                16: "01$%00239C00040A40@^002008040006@&$%00239C00040E40@^002000000C06@*",
                17: "01$%00239C80040A40@^00200804000E@&$%00239C80040E40@^002000000C0E@*",
                18: "01$%00239C40040A40@^002008040001@&$%00239C40040E40@^002000000C01@*",
                19: "01$%00239CC0040A40@^002008040009@&$%00239CC0040E40@^002000000C09@*",
                20: "01$%00239C20040A40@^002008040005@&$%00239C20040E40@^002000000C05@*",
                21: "01$%00239CA0040A40@^00200804000D@&$%00239CA0040E40@^002000000C0D@*",
                22: "01$%00239C60040A40@^002008040003@&$%00239C60040E40@^002000000C03@*",
                23: "01$%00239CE0040A40@^00200804000B@&$%00239CE0040E40@^002000000C0B@*",
                24: "01$%00239C10040A40@^002008040007@&$%00239C10040E40@^002000000C07@*",
                25: "01$%00239C90040A40@^00200804000F@&$%00239C90040E40@^002000000C0F@*",
                26: "01$%00239C50040A40@^002008040000@&$%00239C50040E40@^002000000C00@*",
                27: "01$%00239CD0040A40@^002008040008@&$%00239CD0040E40@^002000000C08@*",
                28: "01$%00239C30040A40@^002008040004@&$%00239C30040E40@^002000000C04@*",
                29: "01$%00239CB0040A40@^00200804000C@&$%00239CB0040E40@^002000000C0C@*",
                30: "01$%00239C70040A40@^002008040002@&$%00239C70040E40@^002000000C02@*"
            },
            "alto": {
                16: "01$%00239C00040A40@^002008040006@&$%00239C00040E40@^002000000A01@*",
                17: "01$%00239C80040A40@^00200804000E@&$%00239C80040E40@^002000000A09@*",
                18: "01$%00239C40040A40@^002008040001@&$%00239C40040E40@^002000000A05@*",
                19: "01$%00239CC0040A40@^002008040009@&$%00239CC0040E40@^002000000A0D@*",
                20: "01$%00239C20040A40@^002008040005@&$%00239C20040E40@^002000000A03@*",
                21: "01$%00239CA0040A40@^00200804000D@&$%00239CA0040E40@^002000000A0B@*",
                22: "01$%00239C60040A40@^002008040003@&$%00239C60040E40@^002000000A07@*",
                23: "01$%00239CE0040A40@^00200804000B@&$%00239CE0040E40@^002000000A0F@*",
                24: "01$%00239C10040A40@^002008040007@&$%00239C10040E40@^002000000A00@*",
                25: "01$%00239C90040A40@^00200804000F@&$%00239C90040E40@^002000000A08@*",
                26: "01$%00239C50040A40@^002008040000@&$%00239C50040E40@^002000000A04@*",
                27: "01$%00239CD0040A40@^002008040008@&$%00239CD0040E40@^002000000A0C@*",
                28: "01$%00239C30040A40@^002008040004@&$%00239C30040E40@^002000000A02@*",
                29: "01$%00239CB0040A40@^00200804000C@&$%00239CB0040E40@^002000000A0A@*",
                30: "01$%00239C70040A40@^002008040002@&$%00239C70040E40@^002000000A06@*"
            },
            "automatico": {
                16: "01$%00239000040A40@^002008040006@&$%00239000040E40@^00200000000C@*",
                17: "01$%00239080040A40@^00200804000E@&$%00239080040E40@^002000000002@*",
                18: "01$%00239040040A40@^002008040001@&$%00239040040E40@^00200000000A@*",
                19: "01$%002390C0040A40@^002008040009@&$%002390C0040E40@^002000000006@*",
                20: "01$%00239020040A40@^002008040005@&$%00239020040E40@^00200000000E@*",
                21: "01$%002390A0040A40@^00200804000D@&$%002390A0040E40@^002000000001@*",
                22: "01$%00239060040A40@^002008040003@&$%00239060040E40@^002000000009@*",
                23: "01$%002390E0040A40@^00200804000B@&$%002390E0040E40@^002000000005@*",
                24: "01$%00239010040A40@^002008040007@&$%00239010040E40@^00200000000D@*",
                25: "01$%00239090040A40@^00200804000F@&$%00239090040E40@^002000000003@*",
                26: "01$%00239050040A40@^002008040000@&$%00239050040E40@^00200000000B@*",
                27: "01$%002390D0040A40@^002008040008@&$%002390D0040E40@^002000000007@*",
                28: "01$%00239030040A40@^002008040004@&$%00239030040E40@^00200000000F@*",
                29: "01$%002390B0040A40@^00200804000C@&$%002390B0040E40@^002000000000@*",
                30: "01$%00239070040A40@^002008040002@&$%00239070040E40@^002000000008@*"
            }
       
        },
        "ventilar": {
            "baixo": {
                16: "01$%0023D800040A40@^002008040001@&$%0023D800040E40@^002000000806@*",
                17: "01$%0023D880040A40@^002008040009@&$%0023D880040E40@^00200000080E@*",
                18: "01$%0023D840040A40@^002008040005@&$%0023D840040E40@^002000000801@*",
                19: "01$%0023D8C0040A40@^00200804000D@&$%0023D8C0040E40@^002000000809@*",
                20: "01$%0023D820040A40@^002008040003@&$%0023D820040E40@^002000000805@*",
                21: "01$%0023D8A0040A40@^00200804000B@&$%0023D8A0040E40@^00200000080D@*",
                22: "01$%0023D860040A40@^002008040007@&$%0023D860040E40@^002000000803@*",
                23: "01$%0023D8E0040A40@^00200804000F@&$%0023D8E0040E40@^00200000080B@*",
                24: "01$%0023D810040A40@^002008040000@&$%0023D810040E40@^002000000807@*",
                25: "01$%0023D890040A40@^002008040008@&$%0023D890040E40@^00200000080F@*",
                26: "01$%0023D850040A40@^002008040004@&$%0023D850040E40@^002000000800@*",
                27: "01$%0023D8D0040A40@^00200804000C@&$%0023D8D0040E40@^002000000808@*",
                28: "01$%0023D830040A40@^002008040002@&$%0023D830040E40@^002000000804@*",
                29: "01$%0023D8B0040A40@^00200804000A@&$%0023D8B0040E40@^00200000080C@*",
                30: "01$%0023D870040A40@^002008040006@&$%0023D870040E40@^002000000802@*"
            },
            "medio": {
                16: "01$%0023DC00040A40@^002008040001@&$%0023DC00040E40@^002000000C01@*",
                17: "01$%0023DC80040A40@^002008040009@&$%0023DC80040E40@^002000000C09@*",
                18: "01$%0023DC40040A40@^002008040005@&$%0023DC40040E40@^002000000C05@*",
                19: "01$%0023DCC0040A40@^00200804000D@&$%0023DCC0040E40@^002000000C0D@*",
                20: "01$%0023DC20040A40@^002008040003@&$%0023DC20040E40@^002000000C03@*",
                21: "01$%0023DCA0040A40@^00200804000B@&$%0023DCA0040E40@^002000000C0B@*",
                22: "01$%0023DC60040A40@^002008040007@&$%0023DC60040E40@^002000000C07@*",
                23: "01$%0023DCE0040A40@^00200804000F@&$%0023DCE0040E40@^002000000C0F@*",
                24: "01$%0023DC10040A40@^002008040000@&$%0023DC10040E40@^002000000C00@*",
                25: "01$%0023DC90040A40@^002008040008@&$%0023DC90040E40@^002000000C08@*",
                26: "01$%0023DC50040A40@^002008040004@&$%0023DC50040E40@^002000000C04@*",
                27: "01$%0023DCD0040A40@^00200804000C@&$%0023DCD0040E40@^002000000C0C@*",
                28: "01$%0023DC30040A40@^002008040002@&$%0023DC30040E40@^002000000C02@*",
                29: "01$%0023DCB0040A40@^00200804000A@&$%0023DCB0040E40@^002000000C0A@*",
                30: "01$%0023DC70040A40@^002008040006@&$%0023DC70040E40@^002000000C06@*"
            },
            "alto": {
                16: "01$%0023DC00040A40@^002008040001@&$%0023DC00040E40@^002000000A05@*",
                17: "01$%0023DC80040A40@^002008040009@&$%0023DC80040E40@^002000000A0D@*",
                18: "01$%0023DC40040A40@^002008040005@&$%0023DC40040E40@^002000000A03@*",
                19: "01$%0023DCC0040A40@^00200804000D@&$%0023DCC0040E40@^002000000A0B@*",
                20: "01$%0023DC20040A40@^002008040003@&$%0023DC20040E40@^002000000A07@*",
                21: "01$%0023DCA0040A40@^00200804000B@&$%0023DCA0040E40@^002000000A0F@*",
                22: "01$%0023DC60040A40@^002008040007@&$%0023DC60040E40@^002000000A00@*",
                23: "01$%0023DCE0040A40@^00200804000F@&$%0023DCE0040E40@^002000000A08@*",
                24: "01$%0023DC10040A40@^002008040000@&$%0023DC10040E40@^002000000A04@*",
                25: "01$%0023DC90040A40@^002008040008@&$%0023DC90040E40@^002000000A0C@*",
                26: "01$%0023DC50040A40@^002008040004@&$%0023DC50040E40@^002000000A02@*",
                27: "01$%0023DCD0040A40@^00200804000C@&$%0023DCD0040E40@^002000000A0A@*",
                28: "01$%0023DC30040A40@^002008040002@&$%0023DC30040E40@^002000000A06@*",
                29: "01$%0023DCB0040A40@^00200804000A@&$%0023DCB0040E40@^002000000A0E@*",
                30: "01$%0023DC70040A40@^002008040006@&$%0023DC70040E40@^002000000A01@*"
            },
            "automatico": {
                16: "01$%0023D000040A40@^002008040001@&$%0023D000040E40@^00200000000A@*",
                17: "01$%0023D080040A40@^002008040009@&$%0023D080040E40@^002000000006@*",
                18: "01$%0023D040040A40@^002008040005@&$%0023D040040E40@^00200000000E@*",
                19: "01$%0023D0C0040A40@^00200804000D@&$%0023D0C0040E40@^002000000001@*",
                20: "01$%0023D020040A40@^002008040003@&$%0023D020040E40@^002000000009@*",
                21: "01$%0023D0A0040A40@^00200804000B@&$%0023D0A0040E40@^002000000005@*",
                22: "01$%0023D060040A40@^002008040007@&$%0023D060040E40@^00200000000D@*",
                23: "01$%0023D0E0040A40@^00200804000F@&$%0023D0E0040E40@^002000000003@*",
                24: "01$%0023D010040A40@^002008040000@&$%0023D010040E40@^00200000000B@*",
                25: "01$%0023D090040A40@^002008040008@&$%0023D090040E40@^002000000007@*",
                26: "01$%0023D050040A40@^002008040004@&$%0023D050040E40@^00200000000F@*",
                27: "01$%0023D0D0040A40@^00200804000C@&$%0023D0D0040E40@^002000000000@*",
                28: "01$%0023D030040A40@^002008040002@&$%0023D030040E40@^002000000008@*",
                29: "01$%0023D0B0040A40@^00200804000A@&$%0023D0B0040E40@^002000000004@*",
                30: "01$%0023D070040A40@^002008040006@&$%0023D070040E40@^00200000000C@*"
            }
        },

        "esquentar": {
            "baixo": {
                16: "01$%00233800040A40@^002008040009@&$%00233800040E40@^00200000080E@*",
                17: "01$%00233880040A40@^002008040005@&$%00233880040E40@^002000000801@*",
                18: "01$%00233840040A40@^00200804000D@&$%00233840040E40@^002000000809@*",
                19: "01$%002338C0040A40@^002008040003@&$%002338C0040E40@^002000000805@*",
                20: "01$%00233820040A40@^00200804000B@&$%00233820040E40@^00200000080D@*",
                21: "01$%002338A0040A40@^002008040007@&$%002338A0040E40@^002000000803@*",
                22: "01$%00233860040A40@^00200804000F@&$%00233860040E40@^00200000080B@*",
                23: "01$%002338E0040A40@^002008040000@&$%002338E0040E40@^002000000807@*",
                24: "01$%00233810040A40@^002008040008@&$%00233810040E40@^00200000080F@*",
                25: "01$%00233890040A40@^002008040004@&$%00233890040E40@^002000000800@*",
                26: "01$%00233850040A40@^00200804000C@&$%00233850040E40@^002000000808@*",
                27: "01$%002338D0040A40@^002008040002@&$%002338D0040E40@^002000000804@*",
                28: "01$%00233830040A40@^00200804000A@&$%00233830040E40@^00200000080C@*",
                29: "01$%002338B0040A40@^002008040006@&$%002338B0040E40@^002000000802@*",
                30: "01$%00233870040A40@^00200804000E@&$%00233870040E40@^00200000080A@*"
            },
            "medio": {
                16: "01$%00233C00040A40@^002008040009@&$%00233C00040E40@^002000000C09@*",
                17: "01$%00233C80040A40@^002008040005@&$%00233C80040E40@^002000000C05@*",
                18: "01$%00233C40040A40@^00200804000D@&$%00233C40040E40@^002000000C0D@*",
                19: "01$%00233CC0040A40@^002008040003@&$%00233CC0040E40@^002000000C03@*",
                20: "01$%00233C20040A40@^00200804000B@&$%00233C20040E40@^002000000C0B@*",
                21: "01$%00233CA0040A40@^002008040007@&$%00233CA0040E40@^002000000C07@*",
                22: "01$%00233C60040A40@^00200804000F@&$%00233C60040E40@^002000000C0F@*",
                23: "01$%00233CE0040A40@^002008040000@&$%00233CE0040E40@^002000000C00@*",
                24: "01$%00233C10040A40@^002008040008@&$%00233C10040E40@^002000000C08@*",
                25: "01$%00233C90040A40@^002008040004@&$%00233C90040E40@^002000000C04@*",
                26: "01$%00233C50040A40@^00200804000C@&$%00233C50040E40@^002000000C0C@*",
                27: "01$%00233CD0040A40@^002008040002@&$%00233CD0040E40@^002000000C02@*",
                28: "01$%00233C30040A40@^00200804000A@&$%00233C30040E40@^002000000C0A@*",
                29: "01$%00233CB0040A40@^002008040006@&$%00233CB0040E40@^002000000C06@*",
                30: "01$%00233C70040A40@^00200804000E@&$%00233C70040E40@^002000000C0E@*"
            },
            "alto": {
                16: "01$%00233C00040A40@^002008040009@&$%00233C00040E40@^002000000A0D@*",
                17: "01$%00233C80040A40@^002008040005@&$%00233C80040E40@^002000000A03@*",
                18: "01$%00233C40040A40@^00200804000D@&$%00233C40040E40@^002000000A0B@*",
                19: "01$%00233CC0040A40@^002008040003@&$%00233CC0040E40@^002000000A07@*",
                20: "01$%00233C20040A40@^00200804000B@&$%00233C20040E40@^002000000A0F@*",
                21: "01$%00233CA0040A40@^002008040007@&$%00233CA0040E40@^002000000A00@*",
                22: "01$%00233C60040A40@^00200804000F@&$%00233C60040E40@^002000000A08@*",
                23: "01$%00233CE0040A40@^002008040000@&$%00233CE0040E40@^002000000A04@*",
                24: "01$%00233C10040A40@^002008040008@&$%00233C10040E40@^002000000A0C@*",
                25: "01$%00233C90040A40@^002008040004@&$%00233C90040E40@^002000000A02@*",
                26: "01$%00233C50040A40@^00200804000C@&$%00233C50040E40@^002000000A0A@*",
                27: "01$%00233CD0040A40@^002008040002@&$%00233CD0040E40@^002000000A06@*",
                28: "01$%00233C30040A40@^00200804000A@&$%00233C30040E40@^002000000A0E@*",
                29: "01$%00233CB0040A40@^002008040006@&$%00233CB0040E40@^002000000A01@*",
                30: "01$%00233C70040A40@^00200804000E@&$%00233C70040E40@^002000000A09@*"
            },
            "automatico": {
                16: "01$%00233000040A40@^002008040009@&$%00233000040E40@^002000000006@*",
                17: "01$%00233080040A40@^002008040005@&$%00233080040E40@^00200000000E@*",
                18: "01$%00233040040A40@^00200804000D@&$%00233040040E40@^002000000001@*",
                19: "01$%002330C0040A40@^002008040003@&$%002330C0040E40@^002000000009@*",
                20: "01$%00233020040A40@^00200804000B@&$%00233020040E40@^002000000005@*",
                21: "01$%002330A0040A40@^002008040007@&$%002330A0040E40@^00200000000D@*",
                22: "01$%00233060040A40@^00200804000F@&$%00233060040E40@^002000000003@*",
                23: "01$%002330E0040A40@^002008040000@&$%002330E0040E40@^00200000000B@*",
                24: "01$%00233010040A40@^002008040008@&$%00233010040E40@^002000000007@*",
                25: "01$%00233090040A40@^002008040004@&$%00233090040E40@^00200000000F@*",
                26: "01$%00233050040A40@^00200804000C@&$%00233050040E40@^002000000000@*",
                27: "01$%002330D0040A40@^002008040002@&$%002330D0040E40@^002000000008@*",
                28: "01$%00233030040A40@^00200804000A@&$%00233030040E40@^002000000004@*",
                29: "01$%002330B0040A40@^002008040006@&$%002330B0040E40@^00200000000C@*",
                30: "01$%00233070040A40@^00200804000E@&$%00233070040E40@^002000000002@*"
            }
        },
        "humidade": {
            "baixo": valor_humidade,
            "medio": valor_humidade,
            "alto": valor_humidade,
            "automatico": valor_humidade
        },
     
        "automatico": {
            "baixo": valor_automatico,
            "medio": valor_automatico,
            "alto": valor_automatico,
            "automatico": valor_automatico
        }

     })

    comando_desligar = "01$%00230200040A40@^00208804000B@&$%00230200040E40@^002000000005@*"

    # Lista ordenada para alternar modo e fan
    modos = ["esfriar", "esquentar", "ventilar", "humidade", "automatico"]
    fans = ["baixo", "medio", "alto", "automatico"]


def carregar_status(devices):
    for dev in devices:
        if dev.get("tipo") == "ar":
            return dev.get("status", {"temperatura": 23, "modo": "esfriar", "fan": "baixo", "ligado": False})
    return {"temperatura": 23, "modo": "esfriar", "fan": "baixo", "ligado": False}

def salvar_status(devices):
    for dev in devices:
        if dev.get("tipo") == "ar":
            dev["status"] = status
            break
    with open("meus_dispositivos.json", "w", encoding="utf-8") as f:
        json.dump(devices, f, indent=4, ensure_ascii=False)


def enviar_comando(key):
    try:
        ir.send_key(HEAD_FIXO, key)        
    except Exception as e:
        print("Erro ao enviar comando:", e)

def alternar_ar(devices, btn, lbl_temp, lbl_modo, lbl_fan):
    global status
    if status.get("ligado"):
        enviar_comando(comando_desligar)
        status["ligado"] = False
    else:
        modo = status["modo"]
        fan = status["fan"]
        temp = status["temperatura"]
        key = comandos_temp.get(modo, {}).get(fan, {}).get(temp)
        if key:
            enviar_comando(key)
            status["ligado"] = True
        else:
            print(f"[ERRO] Sem comando para ligar: modo={modo}, fan={fan}, temp={temp}")
    salvar_status(devices)
    atualizar_status_ar(btn, lbl_temp, lbl_modo, lbl_fan)

def aumentar_temp(devices, btn, lbl_temp, lbl_modo, lbl_fan):
    global status
    modo = status["modo"]
    fan = status["fan"]
    temp = status["temperatura"]
    temperaturas = sorted(comandos_temp.get(modo, {}).get(fan, {}).keys())
    if temp < temperaturas[-1]:
        nova = temperaturas[temperaturas.index(temp) + 1]
        status["temperatura"] = nova
        enviar_comando(comandos_temp[modo][fan][nova])
        salvar_status(devices)
        atualizar_status_ar(btn, lbl_temp, lbl_modo, lbl_fan)

def diminuir_temp(devices, btn, lbl_temp, lbl_modo, lbl_fan):
    global status
    modo = status["modo"]
    fan = status["fan"]
    temp = status["temperatura"]
    temperaturas = sorted(comandos_temp.get(modo, {}).get(fan, {}).keys())
    if temp > temperaturas[0]:
        nova = temperaturas[temperaturas.index(temp) - 1]
        status["temperatura"] = nova
        enviar_comando(comandos_temp[modo][fan][nova])
        salvar_status(devices)
        atualizar_status_ar(btn, lbl_temp, lbl_modo, lbl_fan)

def alternar_modo_ar(event, devices, lbl_temp, lbl_modo, lbl_fan):
    global status
    idx = modos.index(status["modo"])
    novo_modo = modos[(idx + 1) % len(modos)]
    status["modo"] = novo_modo

    fan = status["fan"]
    temp = status["temperatura"]

    key = comandos_temp.get(novo_modo, {}).get(fan, {}).get(temp)
    if key:
        enviar_comando(key)

    salvar_status(devices)
    atualizar_status_ar(None, lbl_temp, lbl_modo, lbl_fan)

def alternar_wind_ar(event, devices, lbl_temp, lbl_modo, lbl_fan):
    global status
    idx = fans.index(status["fan"])
    novo_fan = fans[(idx + 1) % len(fans)]
    status["fan"] = novo_fan

    modo = status["modo"]
    temp = status["temperatura"]

    key = comandos_temp.get(modo, {}).get(novo_fan, {}).get(temp)
    if key:
        enviar_comando(key)

    salvar_status(devices)
    atualizar_status_ar(None, lbl_temp, lbl_modo, lbl_fan)

def atualizar_status_ar(btn, lbl_temp=None, lbl_modo=None, lbl_fan=None):
    global status
    ligado = status.get("ligado")
    temp = status.get("temperatura")
    modo = status.get("modo", "esfriar")
    fan = status.get("fan", "baixo")

    if btn:
        btn.config(text="Desligar" if ligado else "Ligar", bg="lightgreen" if ligado else "#aed6f1")
    if lbl_temp:
        lbl_temp.config(text=f"Temp: {temp}°C")
    if lbl_modo:
        cores = {"esfriar": "blue", "esquentar": "red", "automatico": "green", "ventilar": "orange", "humidecer": "purple"}
        lbl_modo.config(text=modo.capitalize(), fg=cores.get(modo, "black"))
    if lbl_fan:
        lbl_fan.config(text=f"Volume de ar: {fan.capitalize()}")